<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<meta name="description" content="">
		<meta name="author" content="">
		<link rel="icon" href="../../favicon.ico">

		<title>Elvisualisering av Marieberg</title>

		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css">
		<link rel="stylesheet" type="text/css" href="http://cdnjs.cloudflare.com/ajax/libs/dc/1.7.1/dc.css" media="screen"> 
		<link rel="stylesheet" type="text/css" href="style.css"> 

	</head>
<!--<span class="reset" style="display: none;">Current filter: <span class="filter"></span></span>

		    	-->

	<body>
	    <div class="container-fluid">
	    	<div class="row">
	    		<div class="col-md-4" id="meter-chart" style="height:30vh">
	    		</div>
	    		<div class="col-md-8" id="bubble-chart" style="height:30vh">
	    			
	    	</div></div>
	    
	    	<div class="row">
	    		<div class="col-md-4" style="height:10vh">
	    			<button type = "button" class="btn btn-default" onclick="monthlyview()">Månadsvy</button>
	    			<button type = "button" class="btn btn-default" onclick="weeklyview()">Veckovy</button>
		    		<button type = "button" class="btn btn-default" onclick="dailyview()">Dygnsvy</button>
		    	</div>
	    		<div class="col-md-8" id="bar-date-brush" style="height:10vh">
	    		</div>
		    </div>
		    <div class="row">
		    	<div class="col-md-6" id="usage-line-chart" style="height:30vh">
		    		
		    	</div>
		    	<div class="col-md-6" id="month-chart" style="height:30vh">
		    		
		    	</div>
			</div>
			<div class="row">
				<div class="col-md-12" id="day-chart" style="height:30vh"></div>
			</div> 
			<div class="row" style="">
		    		<div class="col-md-4" style="height:30vh; text-align:center; color:black">
		    			<a href="#meter">
		    				<div class="circularMeter"></div>
		    			</a>
			    		<h2>Vilken mätare tillhör jag?</h2>
			    		<p>Beroende på var i huset du sitter tillhör du en av de tio elmätarna.</p>
			    		<a class="btn btn-primary fp-button" href="#meter" title="Program">Läs mer</a>
			    	</div>
		    		<div class="col-md-4" style="height:30vh; text-align:center; color:black">
		    			<h2>Miljöpåverkan</h2>
		    			<p>Hur mycket generar jag? Vad kan jag göra för att minska mina utsläpp?</p>
			    		<a class="btn btn-primary fp-button" href="#environment" title="Program">Läs mer</a>
		    		</div>
			    	<div class="col-md-4" style="height:30vh; text-align:center; color:black">
			    		<h2>Intressant information?</h2>
			    		<p>Vi skriver ett examensarbete om visualisering av elanvändning i kontorsfastigheter. Kontakta gärna oss, vi vill veta mer om vad du tycker!</p>
			    		<a class="btn btn-primary fp-button" href="#info" title="Program">Läs mer</a>

			    	</div>
			
			</div>
			<div id="container" style="width:70%; margin-left:auto; margin-right:auto">
				<div id="meter" class="row" style="height:70vh">
					<div class="col-md-8">
						<h1>Mätare</h1>
						<p> Här finns information om vilken mätare som din plats tillhör</p>
						<ul>
							<li>Jämna våningsplan i höghuset tillhör mätare 227.</li>
							<li>Udda våningsplan i höghuset tillhör mätare 228.</li>
						</ul>
					</div>
					<div class="col-md-4">
						<img src="img/meter.jpg" alt="Spara el" style="height:60vh">
					</div>
				</div>
				<div id="environment" class="row" style="height:70vh">
					<div class="col-md-4">
						<img src="img/treebulb.png" alt="Spara el" style="height:60vh">
					</div> 
					<div class="col-md-8">
						<h1>Miljöpåverkan</h1>
						<div class="row">	
							<div class="col-md-6">
								<h2> Om du...</h2>
							</div>
							<div class="col-md-6">
								<h2> så sparar du...</h2>
							</div>
						</div>
						<div class="row">	
							<div class="col-md-6">
								<p>...stänger av datorn på lunchen,</p>
							</div>
							<div class="col-md-6">
								<p>...20 kWh om året vilket motsvara två kilogram koldioxid</p>
							</div>
						</div>
						<div class="row">	
							<div class="col-md-6">
								<p>...släcker efter dig i konferensrum,</p>
							</div>
							<div class="col-md-6">
								<p>...ganska mycket!</p>
							</div>
						</div>													
					</div>
				</div>
				<div id="info" class="row" style="height:100vh">
					<div class="col-md-8">
						<h1>Intresserad av att veta mer?</h1>
						<p>Det här är ett examensarbete som syftar till att visualisera elförbrukningen i Swecos kontor i Marieberg.</p>
						<p>Kontakta gärna oss om du har några synpunkter eller funderingar kring sidan eller om du har ytterligare förslag på hur det går att minska elförbrukningen.</p>
						<p>Återigen, släck lampan!</p>
					</div>
					<div class="col-md-4">
						<img src="img/contact.jpg" alt="Kontakta oss" style="width:100%">
					</div>
			</div>
		</div>

		<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
	    <!--<script src="../../dist/js/bootstrap.min.js"></script>
	    <script src="../../assets/js/docs.min.js"></script>
	    <script src="../../assets/js/ie10-viewport-bug-workaround.js"></script>	--> 
	    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.js" type="text/javascript"></script>
	    <script type="text/javascript" src="http://cdnjs.cloudflare.com/ajax/libs/crossfilter/1.3.11/crossfilter.js"></script>
	    <script type="text/javascript" src="http://cdnjs.cloudflare.com/ajax/libs/d3/3.4.12/d3.js" ></script>
	    <script type="text/javascript" src="http://cdnjs.cloudflare.com/ajax/libs/dc/2.0.0-alpha.2/dc.js" ></script>    
	    <script type="text/javascript"></script>
	    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>
	    <script src="data.js"></script>
	    <script type="text/javascript">

	var init = function(data){

		function monthlyview(){
	   		updateTimeInterval(dateDim.top(1)[0].hourDate, 2678400000)
		};

		function weeklyview(){
    		updateTimeInterval(dateDim.top(1)[0].hourDate, 604800000)
		};

		function dailyview(){
			updateTimeInterval(dateDim.top(1)[0].hourDate, 86400000)
		};

		function updateTimeInterval(max, diff){
			var minDateDay = new Date(max-diff);
			barDateBrush.filterAll()
			barDateBrush.filter([minDateDay, max]);
		}

        var syncfilters = function(chart, otherChart){
        	if(!chart.dontlisten){
    			otherChart.dontlisten = true;
    			otherChart.filterAll();
    			chart.filters().forEach(function(e){
    				otherChart.filter(e);
    			})
    			otherChart.redraw()
        		otherChart.dontlisten = false;
        	}
        }

		var objectifiedData =[];
		
		var totUsers = 0;		
		var refs = {};
		var days = {};

		startRefPeriod1 = new Date(2014,2,1);
		endRefPeriod1 = new Date(2014,3,30,23,59);
		startRefPeriod2 = new Date(2014,8,1);
		endRefPeriod2 = new Date(2014,9,31,23,59);

		data.forEach(function(meter){
			// add/generate metadata
			totUsers += meter.people;
			refs[meter.id] = [0,0,0,0,0,0,0];
			days[meter.id] = [0,0,0,0,0,0,0];

			meter.data.forEach(function(dataPoint){
				var usageDate = new Date(dataPoint[0]);
	        	var dayDate = new Date(0)
	        	dayDate.setFullYear(usageDate.getFullYear())
	        	dayDate.setMonth(usageDate.getMonth())
	        	dayDate.setDate(usageDate.getDate())
	        	var usage = dataPoint[1];
	        	var nrUsers = meter.people;


	        	if (dayDate >= startRefPeriod1 && dayDate < endRefPeriod1 || 
	        		dayDate >= startRefPeriod2 && dayDate < endRefPeriod2){
	        			refs[meter.id][dayDate.getDay()] += usage; 
	        			++days[meter.id][dayDate.getDay()]; 
	        	}
	        	objectifiedData.push({	
        			hourDate: usageDate, 
        			dayDate: dayDate, 
        			usage: usage, 
        			meter: meter.id, 
        			meanUse: usage/nrUsers, 
        			nrUsers: nrUsers
	        	})
			});
		});


	    var ndx = crossfilter(objectifiedData);
	    var dateDim = ndx.dimension(function (d) {
      		return d.dayDate;
    	});

    	var hourDim = ndx.dimension(function (d) {
    		return d.hourDate;
    	});


	    var meterDim = ndx.dimension(function (d) {
	    	return d.meter;
	    });


	    var usageMeanHour = hourDim.group().reduceSum(function (d) {return d.meanUse;});

   	    var usageSumHour = hourDim.group().reduceSum(function (d) {return d.usage;});

   	    var usageSumDate = hourDim.group(function (d){
   	    	var dayDate = new Date(0)
	        	dayDate.setFullYear(d.getFullYear())
	        	dayDate.setMonth(d.getMonth())
	        	dayDate.setDate(d.getDate())
	        	return dayDate;
   	    }).reduceSum(function (d) {return d.usage;});

   	    usageSumDate.dispose();

   	    var usageSumMeter = meterDim.group().reduceSum(function (d) {return d.meanUse;});




   	    function reduceAddAvg(p,v) {
   	    	++p.hours
   	    	p.elUse  += v.meanUse;
   	    	p.avg = p.elUse/(p.hours/24);
   	    	p.meter = v.meter;
   	    	return p;
   	    }
   	    function reduceRemoveAvg(p,v) {
   	    	--p.hours
   	    	p.elUse -= v.meanUse;
   	    	p.avg = p.elUse/(p.hours/24);
   	    	return p;
   	    }
   	    function reduceInitAvg() {
   	    	return {hours:0, elUse:0, avg:0, meter:""};
   	    }
   	    
   	    var meterDayAvg = meterDim.group().reduce(reduceAddAvg, reduceRemoveAvg, reduceInitAvg);



   	    function allReduceAddAvg(p,v) {
   	    	++p.allHours
   	    	p.users += v.nrUsers;
   	    	p.allElUse  += v.usage;
   	    	p.allAvg = p.allElUse/p.users;
   	    	return p;
   	    }
   	    function allReduceRemoveAvg(p,v) {
   	    	--p.allHours
   	    	p.users -= v.nrUsers;
   	    	p.allElUse -= v.usage;
   	    	p.allAvg = p.allElUse/p.users;

   	    	return p;
   	    }
   	    function allReduceInitAvg() {
   	    	return {allHours:0, users:0, allElUse:0, allAvg:0};
   	    }


   	    var lineHourAvg = hourDim.group().reduce(allReduceAddAvg, allReduceRemoveAvg, allReduceInitAvg);
   	    lineHourAvg.dispose();
   	    

   	    var usageAvgMeter = hourDim.group().reduce(allReduceAddAvg, allReduceRemoveAvg, allReduceInitAvg);

   	    function bubbleReduceAdd(p,v){
   	    	++p.dataPoints;
   	    	++p.nrWeekdays[v.hourDate.getDay()]; 
   	    	
   	    	p.users = v.nrUsers;
   	    	p.usage += v.usage;
   	    	refSum = 0;
   	    	for(i=0; i < p.nrWeekdays.length; i++){
   	    		refSum += p.nrWeekdays[i]*refs[v.meter][i]/24;
   	    	}
   	    	p.change = (p.usage-refSum)/refSum;
   	    	p.meter = v.meter;
   	    	return p;
   	    }
   	    function bubbleReduceRemove(p,v){
   	    	--p.dataPoints
   	    	--p.nrWeekdays[v.hourDate.getDay()]; 
   	    	
   	    	p.users = v.nrUsers;
   	    	p.usage -= v.usage;
   	    	refSum = 0;
   	    	for(i=0; i < p.nrWeekdays.length; i++){
   	    		refSum += p.nrWeekdays[i]*refs[v.meter][i]/days[v.meter][i];
   	    	}
   	    	p.change = (p.usage-refSum)/refSum;
   	    	return p;

   	    }
   	    function bubbleReduceInit(){
   	    	return {nrWeekdays:[0,0,0,0,0,0,0], usage:0, change:0, users:0, dataPoints:0, meter:""}

   	    }
   	    var changeBubble = meterDim.group().reduce(bubbleReduceAdd,bubbleReduceRemove,bubbleReduceInit);


   	    function sumAvgReduceAdd(p,v) {
   	    	++p.hours
   	    	if (p.meters.indexOf(v.meter) == -1){ 
   	    		p.meters[p.meters.length] = v.meter;
   	    		p.users += v.nrUsers;
   	    	};

   	    	p.sumUse += v.usage;
   	    	p.sumUseAvg = p.sumUse/p.users;
   	    	return p;
   	    }
   	    function sumAvgReduceRemove(p,v) {
   	    	--p.hours
   	    	if (p.meters.indexOf(v.meter) !== -1){
   	    		p.meters.splice(p.meters.indexOf(v.meter),1);
   	    		p.users -= v.nrUsers;
   	    	};

   	    	p.sumUse -= v.usage;
   	    	p.sumUseAvg = p.sumUse/p.users;
   	    	return p;
   	    }
   	    function sumAvgReduceInit() {
   	    	return {hours:0, users:0, sumUse:0, sumUseAvg:0, meters:[]};
   	    }
   	    
   	    var usageSumMonth = hourDim.group(function (d){
   	    	var month = new Date(0)
	        	month.setFullYear(d.getFullYear())
	        	month.setMonth(d.getMonth())
	        	return month;
   	    }).reduce(sumAvgReduceAdd, sumAvgReduceRemove, sumAvgReduceInit);



   	    var usageSumDay = hourDim.group(function (d){
   	    	var dayDate = new Date(0)
	        	dayDate.setFullYear(d.getFullYear())
	        	dayDate.setMonth(d.getMonth())
	        	dayDate.setDate(d.getDate())
	        	return dayDate;
   	    }).reduce(sumAvgReduceAdd, sumAvgReduceRemove, sumAvgReduceInit);


/*
   	    function minMaxReduceAdd(p,v){
   	    	if (v.usage < p.min){
   	    		p.min = v.usage;
   	   // 		p.minMax[0] = p.min;
   	    	}
   	    	if (v.usage > p.max){
   	    		p.max = v.usage;
   	    //		p.minMax[1] = p.max;
   	    	}
   	    	
   	    	return p;
   	    }

   	    function minMaxReduceRemove(p,v){
   	    	return p;
   	    }

   	    function minMaxReduceInit(){
   	    	return {minMax:[0,0], min:Infinity, max:0, keyDate:new Date(0)}
   	    }



   	    var maxMinGroup = hourDim.group(function (d){
   	    	var dayDate = new Date(0)
	        	dayDate.setFullYear(d.getFullYear())
	        	dayDate.setMonth(d.getMonth())
	        	dayDate.setDate(d.getDate())
	        	
	        	if (d.getHours() <= 5){
	        		dayDate.setHours(0);
	        		//console.log("morgon",dayDate);
	        	}
	        	else if (d.getHours() > 5 && d.getHours() <= 17){
	        		dayDate.setHours(12)
	        		//console.log("dag",dayDate);
	        	}
	        	else {dayDate.setHours(24);
	        		//console.log("kväll",dayDate);
	        	}
	        	return dayDate;
   	    }).reduce(minMaxReduceAdd, minMaxReduceRemove, minMaxReduceInit);

*/

        var minDate = hourDim.bottom(1)[0].hourDate;
        var maxDate = hourDim.top(1)[0].hourDate;

		var colorScale = d3.scale.ordinal().domain(["s205b", "s207a", "s227a"]).range(["purple", "steelblue", "orange"]);

        var bubbleChart = dc.bubbleChart("#bubble-chart");
        bubbleChart
        	.dimension(meterDim)
        	.group(changeBubble)
      		.colors(colorScale)
      		.colorAccessor(function (d) { return d.value.meter;})
			.keyAccessor(function (p) { return p.value.usage/(p.value.dataPoints*p.value.users/24);})
        	.valueAccessor(function (p) { return p.value.change;})
        	.radiusValueAccessor(function (p) { return p.value.users;})
        	.maxBubbleRelativeSize(0.1)
        	.x(d3.scale.linear().domain([0,5]))
        	.y(d3.scale.linear().domain([0.5,-0.5]))
        	.r(d3.scale.linear().domain([0, 1000]))
        	.renderHorizontalGridLines(true)
        	.yAxisPadding(100)
        	.xAxisPadding(500)


        	.on('filtered', function(chart, filter){
        		syncfilters(chart, meterChart);
        	})

        var today = new Date(hourDim.top(1)[0].hourDate);
        var oneYearAgo = new Date(hourDim.top(1)[0].hourDate);
        oneYearAgo.setFullYear(oneYearAgo.getFullYear()-1);
        var oneWeekAgo = new Date(hourDim.top(1)[0].hourDate-604800000);
        
       	var monthChart = dc.barChart("#month-chart");
        monthChart
        	.dimension(hourDim)
        	.group(usageSumMonth)
          	.x(d3.time.scale().domain([oneYearAgo, today]))
		    .xUnits(function (d){return 20})
	      	//.margins({ top: 50, left: 50, right: 50, bottom: 100 })
          	.brushOn(false)
          	.centerBar(true)
          	.valueAccessor(function (d){ 
          		return d.value.sumUseAvg;})
        	.y(d3.scale.linear().domain([0,150]))

			monthChart.renderlet(function (chart) {
			  chart.selectAll('rect').on("click", function (d) {
			    var minDate = d.x;
			    var maxDate = new Date(minDate);
			    maxDate.setMonth(maxDate.getMonth()+1);
			    maxDate.setHours(maxDate.getHours()-1);
			    if (maxDate > new Date()){
			    	maxDate = new Date(new Date()-86400000);
			    }
			    chart.filterAll();
			    chart.filter([minDate,maxDate]);
			    syncfilters(chart,barDateBrush);
			  });
			});

        var dayChart = dc.barChart("#day-chart");
        dayChart
        	.dimension(hourDim)
        	.group(usageSumDay)
          	.x(d3.time.scale().domain([oneWeekAgo, today]))
		    .xUnits(function (d){return 20})
	      	//.margins({ top: 50, left: 50, right: 50, bottom: 100 })
          	.brushOn(false)
          	.centerBar(true)
          	.valueAccessor(function (d){ 
          		return d.value.sumUseAvg;})
          	.y(d3.scale.linear().domain([0,5]))
          	

        var meterChart = dc.rowChart("#meter-chart");
		meterChart
			.dimension(meterDim)
			.group(meterDayAvg)
			.valueAccessor(function (d) { return d.value.avg; })
	      	.margins({ top: 50, left: 50, right: 50, bottom: 25 })

	      	.colors(colorScale)
	      	.colorAccessor(function (d) { return d.value.meter;})

        	.on('filtered', function(chart, filter){
        		syncfilters(chart, bubbleChart);
        	})
	   //   	.x(d3.scale.linear().domain([0,0.25]))
	     // 	.xAxis().tickValues([0, 0.05, 0.1, 0.15, 0.2])
	     	.elasticX(true)

        var barDateBrush = dc.barChart("#bar-date-brush");
        barDateBrush
        	.elasticX(false)
        	.height(65)
        	.dimension(hourDim)
        	.group(usageSumDate)
        	.x(d3.time.scale().domain([minDate,maxDate]))
        	.xUnits(d3.time.days)

        	.yAxis().ticks(0)


    	var usageLineChart  = dc.compositeChart("#usage-line-chart");

      	usageLineChart
	      	.dimension(hourDim)
	      	.x(d3.time.scale().domain([minDate,maxDate]))
		    .rangeChart(barDateBrush)
		    .xUnits(d3.time.days)
		    .brushOn(false) 
		    .elasticY(true)
		    .on('filtered', function(chart,filter){
						if (chart.filter()[1]-chart.filter()[0] > 2678400000){
						}
					})
	      	.compose([
		        dc.lineChart(usageLineChart)
		        	.group(lineHourAvg)
		        	.valueAccessor(function (d) { return d.value.allAvg})
		        //	.group(maxMinGroup)
					/*.valueAccessor(function (d) {  
						for (i = 0; i = maxMinGroup.size; i++){
							if (i % 2 == 0){ return d.value.max}
							else {return d.value.min}
						}
					})*/
					.dashStyle([15,6])
					.colors("grey")
					.on('filtered', function(chart,filter){
						if (chart.filter()[1]-chart.filter()[0] > 2678400000){
						}
					}),
				dc.lineChart(usageLineChart)
					.group(usageAvgMeter)
		        	.valueAccessor(function (d) { return d.value.allAvg;})
					//.group(maxMinGroup)
					//.valueAccessor(function (d) { return d.value.max;})
		        	.brushOn(false)
	      		]);

	    
	    dc.renderAll(); 

	    updateTimeInterval(hourDim.top(1)[0].hourDate, 2678400000);
	    barDateBrush.render();
	}
	// so that we later can call this with data loaded dynamically
	// currently hardcoded in data.js
	init(data);
	


	    </script>

	</body>

</html>
