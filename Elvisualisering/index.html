<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<meta name="description" content="">
		<meta name="author" content="">
		<link rel="icon" href="../../favicon.ico">

		<title>Elvisualisering av Marieberg</title>

		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css">
		<link rel="stylesheet" type="text/css" href="http://cdnjs.cloudflare.com/ajax/libs/dc/1.7.1/dc.css" media="screen"> 
		<link rel="stylesheet" type="text/css" href="style.css"> 
		<script>
			(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
			(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
			m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
			})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

			ga('create', 'UA-56827816-1', 'auto');
			ga('send', 'pageview');

		</script>

	</head>
<!--<span class="reset" style="display: none;">Current filter: <span class="filter"></span></span>

		    	-->

	<body>
	    <div class="container-fluid" style="margin-left:5px; margin-right:5px">
	    	<h1 style="text-align:center">Interaktiv visualisering av elanvändning i Marieberg</h1>
	    	<div class="row" style="height:28vh">
	    		<div class="col-md-4">
	    			<div class="panel panel-default">
	    				<div class="panel-heading" style="height:3vh; text-align:center; vertical-align:center">
	    					<p class="panel-title">Välj din elmätare</p> 
	    				</div>
		    			<div class="panel-body">
		    				<div class="col-md-12" id="meter-chart" style="height:25vh"></div> 
		    			</div>
	    			</div>
	    		</div>
	    		<div class="col-md-4">
	    			<div class="panel panel-default">
		    			<div class ="panel-heading" style="height:3vh; text-align:center; vertical-align:center">
		    				<p class="panel-titel">Hur ligger ni till?</p>
		    			</div>
		    			<div class="panel-body">
		    				<div class="col-md-12"  id="bubble-chart" style="height:25vh"></div>
			    		</div>
			    	</div>
	    		</div>

	    		<div class="col-md-4">
	    			<div class="panel panel-default">
		    			<div class ="panel-heading" style="height:3vh; text-align:center; vertical-align:center">
		    				<p class="panel-titel">Jämför er förbrukning med snittet</p>
		    			</div>
		    			<div class="panel-body">
			    			<div class="col-md-12"  id="usage-line-chart" style="height:25vh"></div>
			    		</div>
			    	</div>
	    		</div>

	    	</div>
		    <div class="row" style="height:10vh">
		    	<div class="col-md-12">
		    		<div class ="panel panel-default">
		    			<div class="panel-heading" style="height:3vh; text-align:center; vertical-align:center">
		    				<p class="panel title">Välj tidsperiod här</p>
		    			</div>
		    			<div class="panel-body" style="height:7vh">
		    				<div class="col-md-3">
				    			<button type = "button" id ="month-button" class="btn btn-default" style="margin-left:30px" onclick="monthlyview()">Månadsvy</button>
				    			<button type = "button" id ="week-button" class="btn btn-default" onclick="weeklyview()">Veckovy</button>
					    		<button type = "button" id ="day-button" class="btn btn-default" onclick="dailyview()">Dygnsvy</button>
					    	</div>
					    	<div class="col-md-9">
				    			<div clas="col-md-12" id="bar-date-brush" style="width:100%; height:6vh"></div>
				    		</div>
				    	</div>
				    </div>
				</div>
			</div>
					    		

	    	<div class="row" style="height:28vh">	    		
		    	<div class="col-md-4"style="text-align:center">
			    	<div class="panel panel-default">
		    			<div class="panel-heading"style="height:3vh; text-align:center; vertical-align:center">
		    				<p class="panel-title">Topplistan</p> 
		    			</div> 
		    			<div class="panel-body">
		    				<div class="col-md-12" id="accum-change-chart" style="height:25vh"></div> 
		    			</div>
		    		</div>		
		    	</div>
		    	<div class="col-md-4"> 
		    		<div class="panel panel-default">
		    			<div class="panel-heading"style="height:3vh; text-align:center; vertical-align:center">
		    				<p class="panel-title">Senaste året</p> 
		    			</div> 
		    			<div class="panel-body">
		    				<div class="col-md-12" id="month-chart" style="height:25vh"></div> 
		    			</div>
		    		</div>
		    	</div>
		    	<div class="col-md-4">
		    		<div class="panel panel-default">
		    			<div class="panel-heading" style="height:3vh; text-align:center; vertical-align:center">
		    				<p class="panel-title">Senaste veckan</p> 
		    			</div>
		    			<div class="panel-body">
		    				<div class="col-md-12" id="day-chart" style="height:25vh"></div> 
		    			</div>
		    		</div>
		    	</div>
		    </div>

			<div class="row" style="">
		    		<div class="col-md-4" style="height:28vh; text-align:center; color:black">
		    			<!--<a href="#meter">
		    				<div class="circularMeter"></div>
		    			</a>-->
			    		<h2>Vilken mätare tillhör jag?</h2>
			    		<p>Beroende på var i huset du sitter tillhör du en av de tio elmätarna.</p>
			    		<a id="meter-link" class="btn btn-primary fp-button" href="#meter" title="Program">Läs mer</a>
			    	</div>
		    		<div class="col-md-4" style="height:28vh; text-align:center; color:black">
		    			<h2>Miljöpåverkan</h2>
		    			<p>Hur mycket generar jag? Vad kan jag göra för att minska mina utsläpp?</p>
			    		<a id="environment-link" class="btn btn-primary fp-button" href="#environment" title="Program">Läs mer</a>
		    		</div>
			    	<div class="col-md-4" style="height:28vh; text-align:center; color:black">
						<h2>Intressant information?</h2>
				    	<p>Vi skriver ett examensarbete om visualisering av elanvändning i kontorsfastigheter. Kontakta gärna oss, vi vill veta mer om vad du tycker!</p>
				    	<a id="info-link" class="btn btn-primary fp-button" href="#info" title="Program">Läs mer</a>		    		
			    	</div>
			
			</div>
			<div id="container" style="width:70%; margin-left:auto; margin-right:auto">
				<div id="meter" class="row" style="height:70vh">
					<div class="col-md-8">
						<h1>Mätare</h1>
						<p> Här finns information om vilken mätare som din plats tillhör</p>
						<ul>
							<li>Jämna våningsplan i höghuset tillhör mätare 227.</li>
							<li>Udda våningsplan i höghuset tillhör mätare 228.</li>
						</ul>
					</div>
					<div class="col-md-4">
						<img src="img/meter.jpg" alt="Spara el" style="height:60vh">
					</div>
				</div>
				<div id="environment" class="row" style="height:70vh">
					<div class="col-md-4">
						<img src="img/treebulb.png" alt="Spara el" style="height:60vh">
					</div> 
					<div class="col-md-8">
						<h1>Miljöpåverkan</h1>
						<div class="col-md-12"> 
				    		<div class="panel panel-success">
				    			<div class="panel-heading"style="height:5vh; text-align:center; vertical-align:center">
				    				<div class="panel-title" style="font-size:large"><b>Minska enkelt din elanvändning med 10 %</b></div> 
				    			</div> 
				    			<div class="panel-body">
				    				<div class="row">
					    				<div class="col-md-6">
						    				<ul><li><b style="color:#468847">Släck skärmen</b> under lunchen, fikan och möten</li></ul>
						    			</div>
					    				<div class="col-md-6">
						    				<p>- spara 0,1 kWh om dagen</p>
						    			</div>
						    		</div>
				    				<div class="row">
					    				<div class="col-md-6">
						    				<ul><li><b style="color:#468847">Sätt datorn i strömsparläge</b> under lunchen, fikan och möten</li></ul>
						    			</div>
					    				<div class="col-md-6">
						    				<p>- spara 0,04 kWh om dagen</p>
						    			</div>
						    		</div>
				    				<div class="row">
					    				<div class="col-md-6">
						    				<ul><li><b style="color:#468847">Släck lampan</b> efter dig i konferensrummet</li></ul>
						    			</div>
					    				<div class="col-md-6">
						    				<p>- spara ...</p>
						    			</div>
						    		</div>
				    				<div class="row">
					    				<div class="col-md-6">
						    				<ul><li><b style="color:#468847">Använd samma kaffekopp</b> och vattenglas under hela dagen</li></ul>
						    			</div>
					    				<div class="col-md-6">
						    				<p>- spara ...</p>
						    			</div>
						    		</div>
				    				<div class="row">
					    				<div class="col-md-6">
						    				<ul><li><b style="color:#468847">Stäng av datorn och skärmen</b> på nätter och helger</li></ul>
						    			</div>
					    				<div class="col-md-6">
						    				<p>- spara 0,3 kWh per vecka</p>
						    			</div>
						    		</div>
				    				<div class="row">
					    				<div class="col-md-6">
						    				<ul><li><b style="color:#468847">Stäng av skrivare och kaffemaskiner</b> under nätter och helger</li></ul>
						    			</div>
					    				<div class="col-md-6">
						    				<p>- spara ... per vecka</p>
						    			</div>
						    		</div>
				    				<div class="row" style="text-align:right; margin-right:50px">
				    					<p>Så här har vi räknat</p>
						    		</div>
				    			</div>
				    		</div>
				    	</div>
				    	<div class="col-md-12"> 
				    		<div class="panel panel-success">
				    			<div class="panel-heading"style="height:5vh; text-align:center; vertical-align:center">
				    				<div class="panel-title" style="font-size:large"><b>Konsekvenser</b></div> 
				    			</div> 
				    			<div class="panel-body">
				    				<div class="col-md-12">
				    					<p>Om du <b>minskar din elanvändning med 10 %</b> så motsvarar det en minskning av 2,1 kWh i veckan, eller ca 100 kWh om året. Detta motsvarar 10 kg koldioxidekvivalenter om året.</p>
				    					<p></p>
				    					<p>Om alla i hela Marieberg minskar sin elanvändning med 10 % så minskas kontorets elförbrukning med 150 000 kWh om året, motsvarande <b>1,5 ton koldioxidekvivalenter</b>. För motsvarande utsläpp kan man:</p>
				    					<p></p>
				    					<ul>
				    						<li><b>köra tur och retur mellan Stockholm och Rom 17 gånger med en bensinbil,</li><p></p>
				    						<li>göra 38 tur- och returresor med flyg mellan Stockholm och Rom, eller </li><p></p>
				    						<li>odla 15 ton potatis!</b></li>
				    				</div>
				    			</div>
				    		</div>
				    	</div>		
					</div>
				</div>
				<div id="info" class="row" style="height:100vh">
					<div class="col-md-8">
						<h1>Intresserad av att veta mer?</h1>
						<p>Det här projektet är en del av ett examensarbete om visualisering av elförbrukning i kontorsfastigheter.</p>
						<p>Kontakta gärna oss om du har några synpunkter eller funderingar kring sidan eller om du har ytterligare förslag på hur det går att minska elförbrukningen.</p>
						<p>Återigen, släck lampan!</p>
					</div>
					<div class="col-md-4">
						<img src="img/contact.jpg" alt="Kontakta oss" style="width:100%">
					</div>
			</div>
		</div>

		<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
	    <!--<script src="../../dist/js/bootstrap.min.js"></script>
	    <script src="../../assets/js/docs.min.js"></script>
	    <script src="../../assets/js/ie10-viewport-bug-workaround.js"></script>	--> 
	    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.js" type="text/javascript"></script>
	    <script type="text/javascript" src="http://cdnjs.cloudflare.com/ajax/libs/crossfilter/1.3.11/crossfilter.js"></script>
	    <script type="text/javascript" src="http://cdnjs.cloudflare.com/ajax/libs/d3/3.4.12/d3.js" ></script>
	    <script type="text/javascript" src="http://cdnjs.cloudflare.com/ajax/libs/dc/2.0.0-alpha.2/dc.js" ></script>    
	    <script type="text/javascript"></script>
	    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>
	    <script src="data.js"></script>
	    <script type="text/javascript">



	var maxPointsInLineChart = 150;
	var groupByHours = [1,2,4,8,24];

	var init = function(data){

//----------Google Analytics----------------

		$('#month-chart').on('click', function() {
			console.log("month-chart")
			ga('send', 'event', 'month-chart', 'click', 'month-chart-graph');
		});

		$('#day-chart').on('click', function() {
			console.log("day-chart")
			ga('send', 'event', 'day-chart', 'click', 'day-chart-graph');
		});

		$('#month-button').on('click', function() {
			console.log("month-button")
			ga('send', 'event', 'time-button', 'click', 'month-button');
		});

		$('#week-button').on('click', function() {
			console.log("week-button")
			ga('send', 'event', 'time-button', 'click', 'week-button');
		});

		$('#day-button').on('click', function() {
			console.log("day-button")
			ga('send', 'event', 'time-button', 'click', 'day-button');
		});

		$('#bar-date-brush').on('click', function() {
			console.log("bar-date-brush")
			ga('send', 'event', 'bar-date-brush', 'click', 'bar-date-brush');
		});

		$('#meter-chart').on('click', function() {
			if (meterChart.filters().length>0){
				console.log("meter-chart",meterChart.filters())
				ga('send', 'event', 'meter-chart', 'click', meterChart.filters()[0]);
			}
			else {ga('send', 'event', 'meter-chart', 'click', 'unfiltered');}
		});

		$('#bubble-chart').on('click', function() {
			console.log("bubble-chart")
			ga('send', 'event', 'bubble-chart', 'click', 'bubble-chart');
		});

		$('#usage-line-chart').on('click', function() {
			console.log("usage-line-chart")
			ga('send', 'event', 'usage-line-chart', 'click', 'usage-line-chart');
		});

		$('#accum-change-chart').on('click', function() {
			console.log("accum-change-chart")
			ga('send', 'event', 'accum-change-chart', 'click', 'accum-change-chart');
		});

		$('#meter-link').on('click', function() {
			console.log("meter-link")
			ga('send', 'event', 'meter-link', 'click', 'meter-link');
		});

		$('#environment-link').on('click', function() {
			console.log("environment-link")
			ga('send', 'event', 'environment-link', 'click', 'environment-link');
		});

		$('#info-link').on('click', function() {
			console.log("info-link")
			ga('send', 'event', 'info-link', 'click', 'info-link');
		});


		monthlyview = function (){
	   		updateTimeInterval(hourDim.top(1)[0].hourDate, 2678400000)
		};

		weeklyview = function(){
    		updateTimeInterval(hourDim.top(1)[0].hourDate, 604800000)
		};

		dailyview = function (){
			updateTimeInterval(hourDim.top(1)[0].hourDate, 86400000)
		};

		function updateTimeInterval(max, diff){
			var minDateDay = new Date(max-diff);
			barDateBrush.filterAll()
			barDateBrush.filter([minDateDay, max]);
		}

		var onefilter = function(chart, otherChart){
        	if(!chart.dontlisten1){
    			otherChart.dontlisten1 = true;
				var filters = chart.filters();
				if (filters.length > 1){
					var lastFilter = filters[filters.length-1];
					chart.filterAll();
					chart.filter(lastFilter);
				}
        		otherChart.dontlisten1 = false;
        	}
        }

        var syncfilters = function(chart, otherChart){
        	if(!chart.dontlisten){
        		console.log("syncfilters");
    			otherChart.dontlisten = true;
    			otherChart.filterAll();
    			chart.filters().forEach(function(e){
    				otherChart.filter(e);
    			})
    			otherChart.redraw()
        		otherChart.dontlisten = false;
        	}
        }

		var objectifiedData =[];
		
		var totUsers = 0;		
		var refs = {};
		var days = {};


		startRefPeriod1 = new Date(2014,2,1);
		endRefPeriod1 = new Date(2014,4,31,23,59);
		startRefPeriod2 = new Date(2014,8,1);
		endRefPeriod2 = new Date(2014,9,31,23,59);

		data.forEach(function(meter){
			// add/generate metadata
			totUsers += meter.people;
			refs[meter.id] = [0,0,0,0,0,0,0];
			days[meter.id] = [0,0,0,0,0,0,0];

			meter.data.forEach(function(dataPoint){
				var usageDate = new Date(dataPoint[0]);
	        	var dayDate = new Date(0)
	        	dayDate.setFullYear(usageDate.getFullYear())
	        	dayDate.setMonth(usageDate.getMonth())
	        	dayDate.setDate(usageDate.getDate())

	        	var usage = dataPoint[1];
	        	var nrUsers = meter.people;


	        	if (dayDate >= startRefPeriod1 && dayDate < endRefPeriod1 || 
	        		dayDate >= startRefPeriod2 && dayDate < endRefPeriod2){
	        			refs[meter.id][dayDate.getDay()] += usage; 
	        			++days[meter.id][dayDate.getDay()]; 
	        	}

	        	objectifiedData.push({	
        			hourDate: usageDate, 
        			dayDate: dayDate, 
        			usage: usage, 
        			meter: meter.id, 
        			meanUse: usage/nrUsers, 
        			nrUsers: nrUsers
	        	})
			});
		});


	    
	    var ndx = crossfilter(objectifiedData);	    

	    var hourDim = ndx.dimension(function (d) {
    		return d.hourDate;
    	});

	    var meterDim = ndx.dimension(function (d) {
	    	return d.meter;
	    });

	    var usageMeanHour = hourDim.group().reduceSum(function (d) {return d.meanUse;});

   	    var usageSumHour = hourDim.group().reduceSum(function (d) {return d.usage;});

   	    var usageSumDate = hourDim.group(function (d){
   	    	var dayDate = new Date(0)
	        	dayDate.setFullYear(d.getFullYear())
	        	dayDate.setMonth(d.getMonth())
	        	dayDate.setDate(d.getDate())
	        	return dayDate;
   	    }).reduceSum(function (d) {return d.usage;});

   	    usageSumDate.dispose();

   	    var usageSumMeter = meterDim.group().reduceSum(function (d) {return d.meanUse;});




   	    function reduceAddAvg(p,v) {
   	    	++p.hours
   	    	p.elUse  += v.meanUse;
   	    	p.avg = p.elUse/(p.hours/24);
   	    	p.meter = v.meter;
   	    	return p;
   	    }
   	    function reduceRemoveAvg(p,v) {
   	    	--p.hours
   	    	p.elUse -= v.meanUse;
   	    	p.avg = p.elUse/(p.hours/24);
   	    	return p;
   	    }
   	    function reduceInitAvg() {
   	    	return {hours:0, elUse:0, avg:0, meter:""};
   	    }
   	    
   	    var meterDayAvg = meterDim.group().reduce(reduceAddAvg, reduceRemoveAvg, reduceInitAvg);



   	    function allReduceAddAvg(p,v) {
   	    	++p.allHours
   	    	p.users += v.nrUsers;
   	    	p.allElUse  += v.usage;
   	    	p.allAvg = p.allElUse/p.users;
   	    	return p;
   	    }
   	    function allReduceRemoveAvg(p,v) {
   	    	--p.allHours
   	    	p.users -= v.nrUsers;
   	    	p.allElUse -= v.usage;
   	    	p.allAvg = p.allElUse/p.users;

   	    	return p;
   	    }
   	    function allReduceInitAvg() {
   	    	return {allHours:0, users:0, allElUse:0, allAvg:0};
   	    }


   	    var lineHourAvg = hourDim.group().reduce(allReduceAddAvg, allReduceRemoveAvg, allReduceInitAvg);
   	    lineHourAvg.dispose();
   	    

   	    // Create groups for different levels of granularity (1-hour, 6-hour etc)
   	    var prev;
   	    var usageAvgMeter;
   	    for(var i = 0; i < groupByHours.length; i++){

   	    	var timediff = (1000*60*60*groupByHours[i]);
   	    	var groupFunction = function (d){   	    	
	   	    	return new Date(d.getTime()-d.getTime() % timediff);
	   	    };

   	    	var group = hourDim.group(groupFunction).reduce(allReduceAddAvg, allReduceRemoveAvg, allReduceInitAvg);

	   	    group.maxSpan = timediff*maxPointsInLineChart
	   	    group.prev = prev;
	   	    if(prev){
	   	    	prev.next = group;
	   	    }
	   	    prev = group;
	   	    
	   	    // lets create an identical group, but dispose it so it doesn't get filtered
	   	    group.unfiltered = hourDim.group(groupFunction).reduce(allReduceAddAvg, allReduceRemoveAvg, allReduceInitAvg);
	   	    group.unfiltered.dispose()
	   	    usageAvgMeter = group;   
   	    }

   	    var firstDec = new Date()
   	    firstDec.setFullYear(2014)
   	    firstDec.setMonth(10)
   	    firstDec.setDate(8)
   	    firstDec.setHours(0)
   	    firstDec.setMinutes(0)
   	    firstDec.setSeconds(0);
   	    
   	    

   	    function bubbleReduceAdd(p,v){
   	    	++p.dataPoints;
   	    	++p.nrWeekdays[v.hourDate.getDay()]; 

   	    	p.users = v.nrUsers;
   	    	p.usage += v.usage;
   	    	p.meter = v.meter;
   	    	var refSum = 0;
   	    	var refUsage = 0;
   	    	for(i=0; i < p.nrWeekdays.length; i++){
   	    		refSum += p.nrWeekdays[i]*refs[v.meter][i]/days[v.meter][i];  // antalet måndagstimmar i det valda intervallet * referensmåndagsanv / antalet referensmåndagsh
   	    		refUsage = p.nrWeekdays[i]*refs[v.meter][i]/days[v.meter][i];
   	    	}
   	    	p.change = (p.usage-refSum)/refSum;	// --> (måndagsanvändningen-referensmåndagsanvändningen)/referensmåndagsanvändningen
   	    	if (v.hourDate >= firstDec){
   	    		p.accumChange += (v.usage-refUsage)/p.users;
   	    	//	console.log(v.hourDate, v.meter, "Användning", v.usage, "Referensvärde", refUsage, "Accumulerad förändring", p.accumChange);
   	    	}
   	    	return p;
   	    }
   	    function bubbleReduceRemove(p,v){
   	    	--p.dataPoints

   	    	--p.nrWeekdays[v.hourDate.getDay()]; 
   	    	
   	    	p.users = v.nrUsers;
   	    	p.usage -= v.usage;
   	    	refSum = 0;
   	    	for(i=0; i < p.nrWeekdays.length; i++){
   	    		refSum += p.nrWeekdays[i]*refs[v.meter][i]/days[v.meter][i];
   	    	}
   	    	p.change = (p.usage-refSum)/refSum;
   	    	return p;

   	    }
   	    function bubbleReduceInit(){
   	    	return {nrWeekdays:[0,0,0,0,0,0,0], usage:0, change:0, users:0, dataPoints:0, meter:"", accumChange:0, refUsage:0}

   	    }
   	    var changeBubble = meterDim.group().reduce(bubbleReduceAdd,bubbleReduceRemove,bubbleReduceInit);


   	    function sumAvgReduceAdd(p,v) {
   	    	++p.hours
   	    	if (p.meters.indexOf(v.meter) == -1){ 
   	    		p.meters[p.meters.length] = v.meter;
   	    		p.users += v.nrUsers;
   	    	};

   	    	p.sumUse += v.usage;
   	    	p.sumUseAvg = p.sumUse/p.users;
   	    	return p;
   	    }
   	    function sumAvgReduceRemove(p,v) {
   	    	--p.hours
   	    	if (p.meters.indexOf(v.meter) !== -1){
   	    		p.meters.splice(p.meters.indexOf(v.meter),1);
   	    		p.users -= v.nrUsers;
   	    	};

   	    	p.sumUse -= v.usage;
   	    	p.sumUseAvg = p.sumUse/p.users;
   	    	return p;
   	    }
   	    function sumAvgReduceInit() {
   	    	return {hours:0, users:0, sumUse:0, sumUseAvg:0, meters:[]};
   	    }
   	    
   	    var usageSumMonth = hourDim.group(function (d){
   	    	var month = new Date(0)
	        	month.setFullYear(d.getFullYear())
	        	month.setMonth(d.getMonth())
	        	return month;
   	    }).reduce(sumAvgReduceAdd, sumAvgReduceRemove, sumAvgReduceInit);



   	    var usageSumDay = hourDim.group(function (d){
   	    	var dayDate = new Date(0)
	        	dayDate.setFullYear(d.getFullYear())
	        	dayDate.setMonth(d.getMonth())
	        	dayDate.setDate(d.getDate())
	        	return dayDate;
   	    }).reduce(sumAvgReduceAdd, sumAvgReduceRemove, sumAvgReduceInit);



   	    function minMaxReduceAdd(p,v){

  	    	p.users += v.nrUsers;
   	    	p.sumUse += v.usage;
   	    	p.avgUse = p.sumUse/p.users;

   	    	if (v.hourDate.getHours()<=5 || v.hourDate.getHours()>17){
   	    		if (p.maxMin === 0){
   	    			p.maxMin = p.avgUse;
   	    		}
   	    		else if (p.maxMin > p.avgUse){
   	    			p.maxMin = p.avgUse;
   	    		}

   	    	} 
   	    	else{
   	    		if (p.maxMin < p.avgUse){
   	    			p.maxMin = p.avgUse;
   	    		}
   	    	}
   	    	
   	    	return p;
   	    }


   	    function minMaxReduceRemove(p,v){
   	    	p.users -= v.nrUsers;
   	    	p.sumUse -= v.usage;
   	    	p.avgUse = p.sumUse/p.users;

   	    	if (v.hourDate.getHours()<=5 || v.hourDate.getHours()>17){
   	    		if (p.maxMin === 0){
   	    			p.maxMin = p.avgUse;
   	    		}
   	    		else if (p.maxMin > p.avgUse){
   	    			p.maxMin = p.avgUse;
   	    		}

   	    	} 
   	    	else{
   	    		if (p.maxMin < p.avgUse){
   	    			p.maxMin = p.avgUse;
   	    		}
   	    	}
   	    	return p;
   	    }

   	    function minMaxReduceInit(){
   	    	return {maxMin:0, users:0, sumUse:0, avgUse:0}
   	    }



   	    var maxMinGroup = hourDim.group(function (d){
   	    	var dayDate = new Date(0)
	        	dayDate.setFullYear(d.getFullYear())
	        	dayDate.setMonth(d.getMonth())
	        	dayDate.setDate(d.getDate())
	        	
	        	if (d.getHours() <= 5){
	        		dayDate.setHours(0);
	        	}
	        	else if (d.getHours() > 5 && d.getHours() <= 17){
	        		dayDate.setHours(12)
	        	}
	        	else {dayDate.setHours(24);
	        	}
	        	return dayDate;
   	    }).reduce(minMaxReduceAdd, minMaxReduceRemove, minMaxReduceInit);



        var minDate = hourDim.bottom(1)[0].hourDate;
        var maxDate = hourDim.top(1)[0].hourDate;

		var colorScale = d3.scale.ordinal().domain(["s205b", "s207a", "s227a", "s228a", "s206a2", "s204a3"]).range(["purple", "cyan", "orange", "green", "pink", "red"]);

        bubbleChart = dc.bubbleChart("#bubble-chart");
        bubbleChart
        	.dimension(meterDim)
        	.group(changeBubble)
      		.colors(colorScale)
      		.colorAccessor(function (d) { return d.value.meter;})
			.keyAccessor(function (p) { return p.value.usage/(p.value.dataPoints*p.value.users/24);})
        	.valueAccessor(function (p) { return p.value.change;})
        	.radiusValueAccessor(function (p) { return p.value.users;})
        	.maxBubbleRelativeSize(0.1)
        	.x(d3.scale.linear().domain([0,5]))
        	.y(d3.scale.linear().domain([0.5,-0.5]))
        	.r(d3.scale.linear().domain([0, 1000]))
        	.yAxisLabel("Förändring")
        	.xAxisLabel("Förbrukning per timme")
        	.renderHorizontalGridLines(true)
        	.yAxisPadding(100)
        	.xAxisPadding(500)
	      	.margins({ top: 10, left: 50, right: 50, bottom: 50 })


        	.on('filtered', function(chart, filter){
        		onefilter(chart, meterChart);
        		syncfilters(chart, meterChart);
        	})
        	
        	bubbleChart.yAxis().tickFormat(function (v) {return v*100 + '%';})

        var today = new Date(hourDim.top(1)[0].hourDate);
        var oneYearAgo = new Date(hourDim.top(1)[0].hourDate);
        oneYearAgo.setFullYear(oneYearAgo.getFullYear()-1);
        var oneWeekAgo = new Date(hourDim.top(1)[0].hourDate-604800000);
        
       	monthChart = dc.barChart("#month-chart");
        monthChart
        	.dimension(hourDim)
        	.group(usageSumMonth)
          	.x(d3.time.scale().domain([oneYearAgo, today]))
		    .xUnits(function (d){return 20})
	      	//.margins({ top: 50, left: 50, right: 50, bottom: 100 })
          	.brushOn(false)
          	.centerBar(true)
          	.valueAccessor(function (d){ 
          		return d.value.sumUseAvg;})
        	.y(d3.scale.linear().domain([0,150]))
        	.yAxisLabel("kWh")
 			.minHeight(10)

			monthChart.renderlet(function (chart) {
			  chart.selectAll('rect').on("click", function (d) {
			    var minDate = d.x;
			    var maxDate = new Date(minDate);
			    maxDate.setMonth(maxDate.getMonth()+1);
			    maxDate.setHours(maxDate.getHours()-1);
			    if (maxDate > new Date()){
			    	maxDate = new Date(new Date()-86400000);
			    }
			    chart.filterAll();
			    chart.filter([minDate,maxDate]);
			    syncfilters(chart,barDateBrush);
			  });
			});

        dayChart = dc.barChart("#day-chart");
        dayChart
        	.dimension(hourDim)
        	.group(usageSumDay)
          	.x(d3.time.scale().domain([new Date(oneWeekAgo-12*3600*1000), new Date(today-12*3600*1000)]))
		    .xUnits(function (d){return 20})
	      	//.margins({ top: 50, left: 50, right: 50, bottom: 100 })
          	.brushOn(false)
          	.centerBar(true)
          	.valueAccessor(function (d){ return d.value.sumUseAvg;})
          	.y(d3.scale.linear().domain([0,5]))
 			.yAxisLabel("kWh")
 			.minHeight(10)
 			.xAxis().ticks(7)

			dayChart.renderlet(function (chart) {
			  chart.selectAll('rect').on("click", function (d) {
			    var minDate = d.x;
			    var maxDate = new Date(minDate);
			    maxDate.setDate(maxDate.getDate()+1);
			    maxDate.setHours(maxDate.getHours()-1);
			    chart.filterAll();
			    chart.filter([minDate,maxDate]);
			    syncfilters(chart,barDateBrush);
			  });
			});

          	

        meterChart = dc.rowChart("#meter-chart");
		meterChart
			.dimension(meterDim)
			.group(meterDayAvg)
			.valueAccessor(function (d) { return d.value.avg; })
	      	.margins({ top: 10, left: 30, right: 50, bottom: 50 })

	      	.colors(colorScale)
	      	.colorAccessor(function (d) { return d.value.meter;})
        	.on('filtered', function(chart, filter){
        		onefilter(chart, bubbleChart);
        		syncfilters(chart, bubbleChart);
        	})
	   //   	.x(d3.scale.linear().domain([0,0.25]))
	     // 	.xAxis().tickValues([0, 0.05, 0.1, 0.15, 0.2])
	     	.elasticX(true)


	    accumChangeChart = dc.rowChart("#accum-change-chart");
	    accumChangeChart
	    	.dimension(meterDim)
	    	.group(changeBubble)
	    	.valueAccessor(function (d) { return d.value.accumChange;})
	    	.colors(colorScale)
	    	.colorAccessor(function (d) { return d.value.meter;})
	    	.elasticX(true)


        barDateBrush = dc.barChart("#bar-date-brush");
        barDateBrush
        	.elasticX(false)
        	.minHeight(10)
        	.dimension(hourDim)
        	.group(usageSumDate)
        	.x(d3.time.scale().domain([minDate,maxDate]))
        	.xUnits(d3.time.days)

        	.yAxis().ticks(0)
/*
      	function chooseHourGroup(){
      		usageLineChart.on('filtered', function(chart,filter){
      			if (chart.filter()[1]-chart.filter()[0] > 2678400000){
      				return maxMinGroup;
      			}
      			else {return lineHourAvg}
      		})
      	}

      	function chooseMeterGroup(){
      		usageLineChart.on('filtered', function(chart,filter){
      			if (chart.filter()[1]-chart.filter()[0] > 2678400000){
      				return maxMinGroup;
      			}
      			else {return usageAvgMeter}
      		})
      	}
      	function chooseValue(){
      		usageLineChart.on('filtered', function(chart,filter){
      			if (chart.filter()[1]-chart.filter()[0] > 2678400000){
      				return maxMin;
      			}
      			else {return allAvg}
      		})
      	}*/

    	usageLineChart  = dc.compositeChart("#usage-line-chart");


    	usageLineChartFiltered = dc.lineChart(usageLineChart)
					.group(usageAvgMeter)
		        	.valueAccessor(function (d) { return d.value.allAvg;})
					//.group(maxMinGroup)
					//.valueAccessor(function (d) { return d.value.max;})
		        	.brushOn(false)
		usageLineChartUnfiltered = dc.lineChart(usageLineChart)
		        	.group(usageAvgMeter.unfiltered)
		        	.valueAccessor(function (d) { return d.value.allAvg})
					.dashStyle([15,6])
					.colors("grey")
					.brushOn(false)


      	usageLineChart
	      	.dimension(hourDim)
	      	.x(d3.time.scale().domain([minDate,maxDate]))
		    .rangeChart(barDateBrush)
		    .xUnits(d3.time.days)
		    .brushOn(false) 
		    .elasticY(true)
		    .yAxisLabel("kWh per person och timme")
		    .margins({ top: 10, left: 60, right: 50, bottom: 50 })
		    .on('preRedraw', function(chart){
		    	var chart = barDateBrush;
		    	var group = usageLineChartFiltered.group();
		    	if (chart.filter() != null){
			    	var timediff = (chart.filter()[1]-chart.filter()[0]);
			    	
			    	
			    	while(timediff > group.maxSpan && group.next) {
			    		group = group.next;		    		
			    	}
			    	while(timediff < group.maxSpan && group.prev) {
			    		group = group.prev;		    		
			    	}
			    	
			    }
			    else {
			    	var group = usageLineChartFiltered.group();
			    	while(group.next){
			    		group=group.next;
			    	}
			    }

			    if(group!=usageLineChartFiltered.group()){
			    		usageLineChartFiltered.group(group)
			    		usageLineChartUnfiltered.group(group.unfiltered)
			    	}

			})
	      	.compose([
	      			usageLineChartUnfiltered,
					usageLineChartFiltered
	      		]);

	    
	    dc.renderAll(); 

	    updateTimeInterval(hourDim.top(1)[0].hourDate, 604800000);
	    barDateBrush.render();
	}
	// so that we later can call this with data loaded dynamically
	// currently hardcoded in data.js
	init(data);

	    </script>

	</body>

</html>
